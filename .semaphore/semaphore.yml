# Find an example for your language and learn about the core features through
# the guided tour:
# https://docs.semaphoreci.com/category/58-programming-languages
# https://docs.semaphoreci.com/category/56-guided-tour
version: v1.0
name: Hello Semaphore
agent:
  machine:
    type: e1-standard-2
  containers:
    - name: main
      image: ocaml/opam2:debian-8
blocks:
  - name: Build Linux
    task:
      jobs:
        - name: Update opam repo
          commands:
            - opam remote list -s | grep upstream >/dev/null || opam remote add upstream https://opam.ocaml.org
            - opam update
        - name: Install deps from opam
          commands:
            - eval $(opam env)
            - opam switch create . 4.05.0 --deps-only | cat
        - name: Install extra deps from opam
          commands: 
            - opam install js_of_ocaml.3.1.0 | cat
        - name: Build flow
          commands:
            - opam exec -- make bin/flow dist/flow.zip
            - mkdir -p bin/linux && cp bin/flow bin/linux/flow
        - name: Create artifacts
          commands:
            - cp dist/flow.zip dist/flow-linux64.zip
            - cp src/parser/dist/libflowparser.zip dist/libflowparser-linux64.zip
            - cp src/parser/flow_parser.js dist/flow_parser.js
