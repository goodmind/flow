# Find an example for your language and learn about the core features through
# the guided tour:
# https://docs.semaphoreci.com/category/58-programming-languages
# https://docs.semaphoreci.com/category/56-guided-tour
version: v1.0
name: Hello Semaphore
agent:
  machine:
    type: e1-standard-2
  containers:
    - name: main
      image: ocaml/opam2:debian-8
      env_vars:
        - name: TERM
          value: dumb
        - name: OPAMYES
          value: "true"
blocks:
  - name: Linux
    skip:
      when: "tag !~ '.*'"
    task:
      jobs:
        - name: Build
          commands:
            - checkout
            # Install deps
            - sudo apt-get update && sudo apt-get --yes install zip m4
            # Calculate opam version
            - opam --version > .semaphore/opamversion
            # Restore opam cache
            - cache restore opam-cache-$(uname -s)-opam_$(checksum ".semaphore/opamversion")-ocaml_4_05_0-$(checksum "opam")
            # Update opam repo
            - opam remote list -s | grep upstream >/dev/null || opam remote add upstream https://opam.ocaml.org
            - opam update
            # Install deps from opam
            - eval $(opam env)
            - opam switch create . 4.05.0 --deps-only | cat
            # Install extra deps from opam
            - opam install js_of_ocaml.3.1.0 | cat
            # Save opam cache
            - cache store opam-cache-$(uname -s)-opam_$(checksum ".semaphore/opamversion")-ocaml_4_05_0-$(checksum "opam") ~/.opam
            # Build flow
            - ls -alh
            - opam exec -- make bin/flow dist/flow.zip
            - mkdir -p bin/linux && cp bin/flow bin/linux/flow
            # Create artifacts
            - cp dist/flow.zip dist/flow-linux64.zip
            - cp src/parser/dist/libflowparser.zip dist/libflowparser-linux64.zip
            - cp src/parser/flow_parser.js dist/flow_parser.js
